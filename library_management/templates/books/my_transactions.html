{% extends "base.html" %}
{% block title %}My Transactions{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <h2 class="text-2xl font-bold mb-6">My Borrowed Books</h2>

    {% if transactions %}
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white divide-y divide-gray-200 rounded-lg shadow">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Book</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Borrowed On</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3"></th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for transaction in transactions %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">{{ transaction.book.title }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ transaction.borrowed_on|date:"Y-m-d" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ transaction.due_date|date:"Y-m-d" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if transaction.is_returned %}bg-green-100 text-green-800{% elif transaction.is_overdue %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                            {% if transaction.is_returned %}Returned{% elif transaction.is_overdue %}Overdue{% else %}Borrowed{% endif %}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        {% if not transaction.is_returned %}
                        <button onclick="returnBook({{ transaction.id }})"
                                class="text-indigo-600 hover:text-indigo-900">Return</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination (comme dans book_list.html) -->
    {% if is_paginated %}
    <div class="mt-8 flex justify-center">
        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">Previous</a>
            {% endif %}
            {% for i in paginator.page_range %}
                {% if page_obj.number == i %}
                    <span class="relative inline-flex items-center px-4 py-2 border border-indigo-500 bg-indigo-50 text-sm font-medium text-indigo-600">{{ i }}</span>
                {% else %}
                    <a href="?page={{ i }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">{{ i }}</a>
                {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">Next</a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
    {% else %}
    <p class="text-gray-500">You have no borrowed books.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function returnBook(transactionId) {
    fetch('/api/return/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ transaction_id: transactionId })
    }).then(res => res.json()).then(data => {
        if(data.success){ alert('Book returned!'); location.reload(); }
        else{ alert('Error: '+data.error); }
    }).catch(()=>alert('An error occurred.'));
}
</script>
{% endblock %}